<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1" />
        <title>3DUDN</title>
        <link rel="stylesheet" href="../static/style.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bubbly-bg@1.0.0/dist/bubbly-bg.js"></script>
        <script src="static/main.js"></script>
    </head>
    <body>
        <div id="loading">
            <div class="loader bluelight">
                <p>Now Loading...</p>
            </div>
        </div>
        <canvas id="canvas" width="600px" height="600px"></canvas>
        <div class="recordingArea">
            <div id="blink"></div>
            <input type="button" id="recStart" class="recordBtn" onClick="recognition.start();recStart();" value="録音開始" />
            <input type="button" id="recStop" class="recordBtn" onClick="recognition.stop();recStop();" value="録音終了" />
            <input type="button" id="reset" class="recordBtn" onClick="reset();" value="リセット" />
        </div>
        <textarea id="result_text" cols="70" rows="7" readonly></textarea>
        <div class="playArea">
            <button id="play" class="playBtn" onClick="play()" disabled><i
                    class="material-icons">headset</i><span>再生開始</span></button>
            <button id="stop" class="playBtn" onClick="stop()" disabled><i
                    class="material-icons">stop</i><span>再生終了</span></button>
            <button id="halt" class="playBtn" onClick="halt()" disabled><i
                    class="material-icons">pause</i><span>一時停止</span></button>
            <button id="restart" class="playBtn" onClick="restart()" disabled><i
                    class="material-icons">play_arrow</i><span>再開</span></button>
        </div>
        <script>
            // 音声認識
            window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;
                var recognition = new webkitSpeechRecognition();
                recognition.lang = 'ja';
                recognition.continuous = true;
                recognition.interimResults = true;

                let finalTranscript = '';

                recognition.onresult = function (event) {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        let transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            transcript += "。\n";
                            finalTranscript += transcript;
                        } else {
                            interimTranscript = transcript;
                        }
                    }
                    document.getElementById("result_text").innerHTML = finalTranscript + interimTranscript;
                }

                // 再生開始
                function play() {
                    const text = new SpeechSynthesisUtterance(result_text.value);
                    speechSynthesis.speak(text);
                    document.getElementById("play").disabled = true;
                    document.getElementById("stop").disabled = false;
                    document.getElementById("halt").disabled = false;
                    document.getElementById("restart").disabled = true;
                }

                // 再生停止
                function stop() {
                    speechSynthesis.cancel();
                    document.getElementById("play").disabled = false;
                    document.getElementById("stop").disabled = true;
                    document.getElementById("halt").disabled = true;
                    document.getElementById("restart").disabled = true;
                }

                // 再生一時停止
                function halt() {
                    speechSynthesis.pause();
                    document.getElementById("play").disabled = true;
                    document.getElementById("halt").disabled = true;
                    document.getElementById("restart").disabled = false;
                    document.getElementById("stop").disabled = false;
                }

                // 再生再開
                function restart() {
                    speechSynthesis.resume();
                    document.getElementById("play").disabled = true;
                    document.getElementById("restart").disabled = true;
                    document.getElementById("stop").disabled = false;
                    document.getElementById("halt").disabled = false;
                }

                // リセット
                function reset() {
                    document.getElementById("result_text").innerHTML = "";
                    finalTranscript = '';
                    speechSynthesis.cancel();
                    document.getElementById("play").disabled = true;
                    document.getElementById("stop").disabled = true;
                    document.getElementById("halt").disabled = true;
                    document.getElementById("restart").disabled = true;
                }

                // 録音開始
                function recStart() {
                    document.getElementById("blink").innerHTML = '<div id="blinkStart"><i class="material-icons">keyboard_voice</i><span>REC</span></div>';
                    document.getElementById("reset").disabled = true;
                    document.getElementById("play").disabled = true;
                    document.getElementById("recStart").disabled = true;
                }

                // 録音停止
                function recStop() {
                    document.getElementById("blinkStart").innerHTML = '<div id="blink"></div>';
                    document.getElementById("reset").disabled = false;
                    document.getElementById("play").disabled = false;
                    document.getElementById("recStart").disabled = false;
                }

                // background
                bubbly({
                        colorStart: '#6edbff',
                        colorStop: '#6edbff',
                        blur: 5,
                        compose: 'source-over',
                        bubbles: 80,
                        velocityFunc: () => Math.random() * 1.3,
                        radiusFunc: () => Math.random() * 20,
                        bubbleFunc: () => `hsla(${Math.random() * 360}, 50%, 85%, .18)`
                    });
        </script>
    </body>
</html>
