<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1" />
        <title>3DUDN</title>
        <link rel="stylesheet" href="../static/style.css">
        <link rel="shortcut icon" href="../static/images/favicon.ico" type="image/x-icon" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bubbly-bg@1.0.0/dist/bubbly-bg.js"></script>
    </head>
    <body>
        <div id="loading">
            <div class="loader bluelight">
                <p>Now Loading...</p>
            </div>
        </div>

        <div id="chatArea">
            <div id="chatLogs">
            </div>
        </div>

        <form name="example_form" onsubmit="return false;">
            <input type="text" id="chatMessage" name="chatMessage" placeholder="Write message">
            <input type="button" id="recStart_" class="recordBtn" value="録音開始" />
            <input type="button" id="recStop_" class="recordBtn" value="録音終了" />
            <button onclick="changeHandler(document.getElementById('chatMessage'))">submit</button>
        </form>

        <div id="modelChangeArea">
            <form id="uploadForm" method="post" action="/upload" enctype="multipart/form-data" onsubmit="return false;">
                <input id="upFile" type="file" name="the_file">
                <button id="uploadBtn" onclick="uploadFormSubmit(document.getElementById('upFile'))">upload</button>
            </form>
        </div>

        <canvas id="canvas" width="600px" height="600px"></canvas>

        <script src="static/main.js"></script>
        <script>
            // チャット機能
            function changeHandler(input_value) {
                const chatMessage = $(input_value).serialize();

                // 送信メッセージの表示
                $("#chatLogs").append("<div class='chatLog'>" + input_value.value + "</div>");
                // 入力欄の初期化
                document.getElementById('chatMessage').value = "";
                finalTranscript = "";

                $.ajax("/show", {
                    type: "post",
                    data: chatMessage,  // POSTでサーバーに送信するデータ
                    dataType: "json",
                }).done(function (data) { // 成功した場合実行される
                    console.log("Ajax通信 成功");

                    // POSTリクエストの結果を受け取ってHTMLを書き換える
                    const message = JSON.parse(data.values).message

                    // 受信メッセージの表示
                    $("#chatLogs").append("<div class='chatLog'>" + message + "</div>");

                    // 受信メッセージの読み上げ
                    const text = new SpeechSynthesisUtterance(message);
                    speechSynthesis.speak(text);

                }).fail(function (data) { // 失敗した場合実行される
                    console.log("Ajax通信 失敗");
                });
            }

            // モデル変更機能
            function uploadFormSubmit(input_value) {
                var formData = new FormData($('#uploadForm')[0]);
                $.ajax({
                    url: '/upload',
                    type: 'post',
                    data: formData,
                    processData: false,
                    contentType: false,
                    timeout: 10000
                }).done(function () {
                    // form要素の削除
                    var parent = document.getElementById('modelChangeArea');
                    var child = document.getElementById('uploadForm');
                    parent.removeChild(child);

                    // #modelChangeBtnを追加
                    var newElement = document.createElement("button");
                    var newContent = document.createTextNode("Model Change");
                    newElement.appendChild(newContent);
                    newElement.setAttribute("id", "modelChangeBtn");
                    parent.appendChild(newElement);
                }).fail(function () {
                    console.log('fail');
                });

            };
        </script>
    </body>
</html>
